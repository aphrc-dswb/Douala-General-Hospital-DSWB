--VISIT_OCCURRENCE
-- Step 1: Ensure sequence exists for visit_occurrence_id

CREATE SEQUENCE IF NOT EXISTS "tb_cdm"."visit_occurrence_id_seq"
    START WITH 1
    INCREMENT BY 1
    OWNED BY "tb_cdm"."visit_occurrence".visit_occurrence_id;

-- Step 2: Insert into visit_occurrence 
INSERT INTO "tb_cdm"."visit_occurrence" (
    visit_occurrence_id,
    person_id,
    visit_concept_id,
    visit_start_date,
    visit_start_datetime,
    visit_end_date,
    visit_end_datetime,
    visit_type_concept_id,
    provider_id,
    care_site_id,
    visit_source_value,
    visit_source_concept_id,
    admitted_from_concept_id,
    admitted_from_source_value,
    discharged_to_concept_id,
    discharged_to_source_value,
    preceding_visit_occurrence_id
)
SELECT
    nextval('"tb_cdm"."visit_occurrence_id_seq"') AS visit_occurrence_id,
    p.person_id,
    9201 AS visit_concept_id, -- Inpatient visit
    TO_DATE(s.year_of_treatment_start::text || '-01-01', 'YYYY-MM-DD') AS visit_start_date,
    TO_DATE(s.year_of_treatment_start::text || '-01-01', 'YYYY-MM-DD') AS visit_start_datetime,
    TO_DATE(s.year_of_treatment_start::text || '-01-01', 'YYYY-MM-DD') AS visit_end_date,
    TO_DATE(s.year_of_treatment_start::text || '-01-01', 'YYYY-MM-DD') AS visit_end_datetime,
    32818 AS visit_type_concept_id, -- EHR administration record
    NULL AS provider_id,
    NULL AS care_site_id,
    NULL AS visit_source_value,
    NULL AS visit_source_concept_id,
    NULL AS admitted_from_concept_id,
    NULL AS admitted_from_source_value,
    NULL AS discharged_to_concept_id,
    NULL AS discharged_to_source_value,
    NULL AS preceding_visit_occurrence_id
FROM "tb_dgh_2009_2022" s
JOIN "tb_cdm"."person" p 
    ON p.person_source_value = s.uniqueid
WHERE s.year_of_treatment_start IS NOT NULL;
